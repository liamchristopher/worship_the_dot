name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  version_parity:
    name: Version Parity Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install package and dev deps
        run: |
          uv pip install -e .
          uv pip install -r requirements-dev.txt

      - name: Run version parity test only
        run: |
          uv run pytest -q tests/test_version_parity.py

  test:
    name: Tests (Python 3.12)
    runs-on: ubuntu-latest
    needs: [version_parity]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install package and dev deps
        run: |
          uv pip install -e .
          uv pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          uv run pytest --cov=dot --cov-report=term-missing --cov-fail-under=90

  commit_policy:
    name: Commit Message Policy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install THE DOT CLI
        run: |
          uv pip install -e .

      - name: Check push commits
        if: github.event_name == 'push'
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          MISSING=0
          MESSAGES=$(jq -r '.commits[]?.message + "\u0000"' "$GITHUB_EVENT_PATH")
          if [ -z "$MESSAGES" ]; then
            echo "No commits found in push payload."
            exit 0
          fi
          while IFS= read -r -d '' msg; do
            [ -z "$msg" ] && continue
            echo "Validating commit message:"; printf '%s\n' "$msg"; echo "---"
            if ! uv run dot validate "$msg"; then
              echo "âŒ Missing required suffix" >&2
              MISSING=1
            fi
          done <<< "$MESSAGES"
          if [ "$MISSING" -ne 0 ]; then
            echo "One or more commit messages do not properly worship THE DOT." >&2
            exit 1
          fi

      - name: Check PR commits
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const required = 'BECAUSE I WORSHIP THE DOT';
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const commits = await github.rest.pulls.listCommits({ owner, repo, pull_number: pr.number, per_page: 250 });
            const bad = commits.data.filter(c => !c.commit.message.trim().endsWith(required));
            if (bad.length) {
              core.startGroup('Commits missing required suffix');
              for (const c of bad) core.error(`Commit ${c.sha.slice(0,7)}: "${c.commit.message.split('\n')[0]}"`);
              core.endGroup();
              core.setFailed('One or more commit messages do not properly worship THE DOT.');
            }
