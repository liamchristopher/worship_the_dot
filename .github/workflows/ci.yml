name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  test:
    name: Tests (Python 3.12)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install package and dev deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          pytest --cov=dot --cov-report=term-missing --cov-fail-under=90

  commit_policy:
    name: Commit Message Policy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check push commits
        if: github.event_name == 'push'
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          REQUIRED="BECAUSE I WORSHIP THE DOT"
          MISSING=0
          # Extract commit messages from push event
          MESSAGES=$(jq -r '.commits[]?.message // empty' "$GITHUB_EVENT_PATH")
          if [ -z "$MESSAGES" ]; then
            echo "No commits found in push payload."
            exit 0
          fi
          while IFS= read -r msg; do
            if ! printf "%s" "$msg" | grep -Eq "${REQUIRED}[[:space:]]*$"; then
              echo "Commit message missing required suffix:" >&2
              echo "---" >&2
              echo "$msg" >&2
              echo "---" >&2
              MISSING=1
            fi
          done <<< "$MESSAGES"
          if [ "$MISSING" -ne 0 ]; then
            echo "One or more commit messages do not properly worship THE DOT." >&2
            exit 1
          fi

      - name: Check PR commits
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const required = 'BECAUSE I WORSHIP THE DOT';
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const commits = await github.rest.pulls.listCommits({ owner, repo, pull_number: pr.number, per_page: 250 });
            const bad = commits.data.filter(c => !c.commit.message.trim().endsWith(required));
            if (bad.length) {
              core.startGroup('Commits missing required suffix');
              for (const c of bad) core.error(`Commit ${c.sha.slice(0,7)}: "${c.commit.message.split('\n')[0]}"`);
              core.endGroup();
              core.setFailed('One or more commit messages do not properly worship THE DOT.');
            }
